<!DOCTYPE html>
<script>
  const APP_VERSION = 'v3-2025-08-09'; // 每次发布改这里
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register(`./sw.js?v=${encodeURIComponent(APP_VERSION)}`);
    });
  }
</script>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111827"/>
<title>家庭激励系统 · PWA v3（云同步）</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f7f7f8; color:#222;}
  header{position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; z-index:10;}
  header h1{margin:0; font-size:18px;}
  .update-banner{display:none; background:#111; color:#fff; padding:8px 12px; text-align:center;}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  .tab{padding:8px 12px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; font-size:14px;}
  .tab.active{background:#111; color:#fff; border-color:#111;}
  main{padding:16px; max-width:1100px; margin:0 auto;}
  section{display:none;}
  section.active{display:block;}
  h2{font-size:18px; margin:12px 0;}
  .grid{display:grid; gap:12px;}
  .grid.cols-2{grid-template-columns:1fr 1fr;}
  .card{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;}
  table{width:100%; border-collapse:collapse; font-size:14px;}
  th,td{border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top;}
  tr:last-child td{border-bottom:none;}
  input[type="text"], input[type="number"], input[type="password"], input[type="date"], select, textarea{
    width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; font-size:14px;
  }
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .btn{padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#111; color:#fff; cursor:pointer; font-size:14px;}
  .btn.secondary{background:#fff; color:#111;}
  .muted{color:#6b7280; font-size:12px;}
  .kpi{display:flex; gap:16px; flex-wrap:wrap;}
  .kpi .item{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-width:140px;}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px;}
  .badge{display:inline-block; padding:2px 6px; border-radius:6px; background:#e2e8f0; font-size:12px;}
</style>
</head>
<body>
<header>
  <div class="update-banner" id="updateBanner">
    发现新版本，<button class="btn" id="refreshBtn" style="padding:4px 8px">点击更新</button>
  </div>
  <h1>家庭激励系统 · PWA v3（云同步）</h1>
  <div class="tabs" id="tabs"></div>
</header>

<main>
  <!-- 云同步 -->
  <section id="tab-cloud" class="active">
    <div class="grid cols-2">
      <div class="card">
        <h2>登录 / 注册</h2>
        <div class="grid">
          <label>邮箱：<input id="sb_email" type="text" placeholder="you@example.com"/></label>
          <label>密码：<input id="sb_password" type="password" placeholder="至少 6 位"/></label>
          <div class="row">
            <button class="btn" id="sb_signin">登录</button>
            <button class="btn secondary" id="sb_signup">注册</button>
            <button class="btn secondary" id="sb_signout">退出登录</button>
          </div>
          <div class="muted" id="sb_status">未登录</div>
        </div>
      </div>
      <div class="card">
        <h2>家庭空间</h2>
        <div class="grid">
          <label>Supabase URL（一次设置）：<input id="sb_url" placeholder="https://xxx.supabase.co"/></label>
          <label>Anon Key（一次设置）：<input id="sb_anon" placeholder="ey..."/></label>
          <label>家庭ID（英文/数字/中横线）：<input id="family_id" placeholder="如 yuan-home"/></label>
          <div class="row">
            <button class="btn" id="btn_save_cfg">保存配置</button>
            <button class="btn" id="btn_pull">从云端拉取</button>
            <button class="btn" id="btn_push">推送本地到云</button>
            <label class="row"><input id="auto_sync" type="checkbox"/> 自动同步（30 秒）</label>
          </div>
          <div class="muted" id="cloud_info">云端：未连接</div>
        </div>
      </div>
    </div>
    <div class="card mt16">
      <h2>冲突处理</h2>
      <p class="muted">默认 Last-Write-Wins；也可手动“拉取/推送”。</p>
      <div class="row"><button class="btn secondary" id="btn_backup">下载本地备份 JSON</button></div>
    </div>
  </section>

  <!-- 今日任务（精简版） -->
  <section id="tab-today">
    <div class="grid cols-2">
      <div class="card">
        <h2>今日任务清单</h2>
        <div class="row">
          <input id="newTaskName" placeholder="新增任务"/>
          <input id="newTaskPoints" type="number" placeholder="积分" min="1" style="max-width:120px"/>
          <select id="newTaskType" style="max-width:140px">
            <option value="基础任务">基础任务</option>
            <option value="成长任务">成长任务</option>
            <option value="自选任务">自选任务</option>
          </select>
          <button class="btn" id="addTaskBtn">新增任务</button>
        </div>
        <table id="taskTable"><thead><tr><th>完成</th><th>任务</th><th>类型</th><th>积分</th><th></th></tr></thead><tbody></tbody></table>
        <div class="row mt16">
          <button class="btn" id="saveTodayBtn">保存今日</button>
          <span class="muted" id="todayInfo"></span>
        </div>
      </div>
      <div class="card">
        <h2>今日汇总</h2>
        <div class="kpi">
          <div class="item"><div class="muted">今日日期</div><div id="todayDate"></div></div>
          <div class="item"><div class="muted">今日总分</div><div id="todayTotal" style="font-weight:600"></div></div>
          <div class="item"><div class="muted">本周累计</div><div id="weekTotal" style="font-weight:600"></div></div>
        </div>
        <h3 class="mt16">今日完成记录</h3>
        <table id="todayLog"><thead><tr><th>任务</th><th>类型</th><th>积分</th><th>完成</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- 奖励与兑换（缩略） -->
  <section id="tab-reward">
    <div class="grid cols-2">
      <div class="card">
        <h2>奖励菜单</h2>
        <div class="row">
          <input id="rewardName" placeholder="奖励名称（如：30 分钟游戏券）"/>
          <input id="rewardCost" type="number" placeholder="所需积分" min="1" style="max-width:140px"/>
          <select id="rewardType" style="max-width:140px">
            <option value="数字类">数字类</option>
            <option value="情感类">情感类</option>
            <option value="体验类">体验类</option>
            <option value="自由类">自由类</option>
          </select>
          <button class="btn" id="addRewardBtn">新增奖励</button>
        </div>
        <table id="rewardTable"><thead><tr><th>类别</th><th>奖励</th><th>所需积分</th><th></th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h2>积分兑换</h2>
        <div class="kpi">
          <div class="item"><div class="muted">可用积分</div><div id="availablePoints" style="font-weight:600"></div></div>
          <div class="item"><div class="muted">本周兑换次数</div><div id="redeemCount" style="font-weight:600"></div></div>
        </div>
        <div class="row mt16">
          <select id="rewardSelect" style="min-width:240px"></select>
          <input id="reserveDate" type="date" />
          <button class="btn" id="redeemBtn">兑换</button>
        </div>
        <h3 class="mt16">兑换记录</h3>
        <table id="redeemLog"><thead><tr><th>时间</th><th>奖励</th><th>消耗</th><th>预约日</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- 时间券（缩略） -->
  <section id="tab-coupons">
    <div class="grid cols-2">
      <div class="card">
        <h2>时间券库存</h2>
        <table id="couponTable"><thead><tr><th>券名</th><th>库存</th><th></th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h2>时间券预约/使用</h2>
        <div class="row">
          <select id="couponSelect" style="min-width:240px"></select>
          <input id="couponDate" type="date"/>
          <button class="btn" id="useCouponBtn">标记使用</button>
        </div>
        <h3 class="mt16">使用记录</h3>
        <table id="couponLog"><thead><tr><th>时间</th><th>券名</th><th>预约日</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- 周报（缩略） -->
  <section id="tab-report">
    <div class="card">
      <h2>周报图表</h2>
      <canvas id="chartWeeklyScore" height="140"></canvas>
      <canvas id="chartTaskCount" height="140" style="margin-top:16px"></canvas>
    </div>
  </section>

  <!-- 设置 -->
  <section id="tab-settings">
    <div class="grid cols-2">
      <div class="card">
        <h2>系统设置</h2>
        <div class="grid">
          <label>每周兑换次数上限：<input id="maxWeeklyRedeem" type="number" min="1" value="2"/></label>
          <label>每日积分上限：<input id="maxDailyPoints" type="number" min="1" value="30"/></label>
          <label>每日使用时间券上限：<input id="maxDailyCoupons" type="number" min="1" value="1"/></label>
          <label>时间券默认有效天数：<input id="couponExpireDays" type="number" min="1" value="14"/></label>
        </div>
        <div class="row mt16">
          <button class="btn" id="saveSettingsBtn">保存设置</button>
          <span class="muted" id="settingsInfo"></span>
        </div>
      </div>
      <div class="card">
        <h2>数据管理</h2>
        <div class="row">
          <button class="btn" id="exportBtn">导出数据（JSON）</button>
          <input type="file" id="importFile" accept="application/json"/>
          <button class="btn secondary" id="importBtn">导入</button>
          <button class="btn secondary" id="resetBtn">清空所有数据</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
// PWA update banner
let newWorker;
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      reg.addEventListener('updatefound', () => {
        newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            document.getElementById('updateBanner').style.display = 'block';
          }
        });
      });
    });
  });
}
document.getElementById('refreshBtn').onclick = () => {
  if (newWorker) newWorker.postMessage({type:'SKIP_WAITING'});
  window.location.reload();
};

// Helpers
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const todayStr = () => new Date().toISOString().slice(0,10);
const weekStartStr = (d=new Date())=>{
  const date = new Date(d);
  const day = date.getDay();
  const diff = (day===0? -6 : 1) - day;
  date.setDate(date.getDate()+diff);
  return date.toISOString().slice(0,10);
};

// State
const defaultState = {
  settings:{ maxWeeklyRedeem:2, maxDailyPoints:30, maxDailyCoupons:1, couponExpireDays:14 },
  tasks:[
    {id:1,name:"按时完成语文作业",points:5,type:"基础任务"},
    {id:2,name:"按时完成数学作业",points:5,type:"基础任务"},
    {id:3,name:"阅读课外书 20 分钟",points:3,type:"成长任务"}
  ],
  rewards:[
    {id:1,type:"数字类",name:"15 分钟游戏券",cost:10, coupon:true},
    {id:2,type:"数字类",name:"30 分钟游戏券",cost:20, coupon:true}
  ],
  records:{},
  redeem:[],
  coupons:{},
  couponLogs:[]
};
function loadState(){
  try{
    const raw = localStorage.getItem("family_reward_state_pwa_v3");
    if(!raw){ saveState(defaultState); return JSON.parse(JSON.stringify(defaultState)); }
    return JSON.parse(raw);
  }catch(e){ console.error(e); return JSON.parse(JSON.stringify(defaultState)); }
}
function saveState(s){ localStorage.setItem("family_reward_state_pwa_v3", JSON.stringify(s)); }
let state = loadState();

// Tabs
window.tabDefs = [
  {id:"cloud", name:"云同步"},
  {id:"today", name:"今日任务"},
  {id:"reward", name:"积分与兑换"},
  {id:"coupons", name:"时间券"},
  {id:"report", name:"周报图表"},
  {id:"settings", name:"设置/导入导出"}
];
function renderTabs(){
  const tabsEl = document.getElementById("tabs");
  tabsEl.innerHTML = "";
  window.tabDefs.forEach((t, i)=>{
    const b = document.createElement("button");
    b.className = "tab" + (i===0?" active":"");
    b.textContent = t.name;
    b.onclick = ()=>{
      $$(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $$("main section").forEach(sec=>sec.classList.remove("active"));
      document.getElementById("tab-"+t.id).classList.add("active");
      if(t.id==="report") renderCharts();
      if(t.id==="coupons") { renderCoupons(); }
      if(t.id==="reward") { renderRewards(); renderRedeemLog(); }
    };
    tabsEl.appendChild(b);
  });
}

// Today
function ensureRecord(date){
  if(!state.records[date]) state.records[date] = {items:{}, total:0};
}
function renderTaskTable(){
  const tb = $("#taskTable tbody");
  tb.innerHTML = "";
  const date = todayStr();
  ensureRecord(date);
  state.tasks.forEach(task=>{
    const tr = document.createElement("tr");
    const rec = state.records[date].items[task.id] || {done:false};
    tr.innerHTML = `
      <td><input type="checkbox" ${rec.done?"checked":""} data-id="${task.id}" class="doneBox"/></td>
      <td>${task.name}</td>
      <td>${task.type}</td>
      <td>${task.points}</td>
      <td><button class="btn secondary" data-id="${task.id}" data-act="del">删除</button></td>
    `;
    tb.appendChild(tr);
  });
  $("#todayDate").textContent = todayStr();
  recomputeToday();
}
function recomputeToday(){
  const date = todayStr(); ensureRecord(date);
  let total = 0;
  state.tasks.forEach(t=>{
    const rec = state.records[date].items[t.id];
    if(rec && rec.done){ total += t.points; }
  });
  const cap = Number(state.settings.maxDailyPoints||30);
  if(total>cap) total = cap;
  state.records[date].total = total;
  $("#todayTotal").textContent = total;
  const tb = $("#todayLog tbody"); tb.innerHTML = "";
  state.tasks.forEach(t=>{
    const rec = state.records[date].items[t.id] || {done:false};
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${t.name}</td><td>${t.type}</td><td>${t.points}</td><td>${rec.done?"✔":""}</td>`;
    tb.appendChild(tr);
  });
  $("#weekTotal").textContent = weekTotal(new Date());
  $("#availablePoints").textContent = availablePoints();
}
document.addEventListener("change",(e)=>{
  if(e.target.classList.contains("doneBox")){
    const id = Number(e.target.dataset.id);
    const date = todayStr();
    ensureRecord(date);
    state.records[date].items[id] = state.records[date].items[id] || {done:false};
    state.records[date].items[id].done = e.target.checked;
    recomputeToday();
  }
});
$("#addTaskBtn").onclick = ()=>{
  const name = $("#newTaskName").value.trim();
  const pts = Number($("#newTaskPoints").value);
  const type = $("#newTaskType").value;
  if(!name || !pts){ alert("请填写任务名称与积分"); return; }
  const id = (state.tasks.reduce((m,t)=>Math.max(m,t.id),0) || 0) + 1;
  state.tasks.push({id,name,points:pts,type});
  $("#newTaskName").value=""; $("#newTaskPoints").value="";
  renderTaskTable(); saveState(state);
};
$("#taskTable").addEventListener("click",(e)=>{
  if(e.target.dataset.act==="del"){
    const id = Number(e.target.dataset.id);
    state.tasks = state.tasks.filter(t=>t.id!==id);
    Object.values(state.records).forEach(r=>{ if(r.items[id]) delete r.items[id]; });
    renderTaskTable(); saveState(state);
  }
});
$("#saveTodayBtn").onclick = ()=>{ saveState(state); $("#todayInfo").textContent = "今日记录已保存"; setTimeout(()=>$("#todayInfo").textContent="",1500); };

function weekTotal(d){
  const start = new Date(weekStartStr(d));
  let sum = 0;
  for(let i=0;i<7;i++){
    const dt = new Date(start); dt.setDate(start.getDate()+i);
    const key = dt.toISOString().slice(0,10);
    if(state.records[key]) sum += (state.records[key].total||0);
  }
  return sum;
}
function availablePoints(){
  let earned = 0;
  Object.values(state.records).forEach(r=>earned+= (r.total||0));
  let spent = 0;
  state.redeem.forEach(r=>spent += (r.cost||0));
  return Math.max(0, earned - spent);
}

// Rewards
function renderRewards(){
  const tb = $("#rewardTable tbody"); tb.innerHTML="";
  state.rewards.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.type}</td><td>${r.name}${r.coupon?'（时间券）':''}</td><td>${r.cost}</td>
      <td><button class="btn secondary" data-id="${r.id}" data-act="del-reward">删除</button></td>`;
    tb.appendChild(tr);
  });
  const sel = $("#rewardSelect"); sel.innerHTML="";
  state.rewards.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id; opt.textContent = `[${r.type}] ${r.name}（${r.cost} 分）`;
    sel.appendChild(opt);
  });
  $("#availablePoints").textContent = availablePoints();
  $("#redeemCount").textContent = redeemCountThisWeek();
}
function redeemCountThisWeek(){
  const ws = weekStartStr();
  return state.redeem.filter(r=>r.weekStart===ws).length;
}
$("#addRewardBtn").onclick = ()=>{
  const name = $("#rewardName").value.trim();
  const cost = Number($("#rewardCost").value);
  const type = $("#rewardType").value;
  if(!name || !cost){ alert("请填写奖励名称与所需积分"); return; }
  const id = (state.rewards.reduce((m,t)=>Math.max(m,t.id),0) || 0) + 1;
  const coupon = /券/.test(name);
  state.rewards.push({id,type,name,cost,coupon});
  $("#rewardName").value=""; $("#rewardCost").value="";
  renderRewards(); saveState(state);
};
$("#rewardTable").addEventListener("click",(e)=>{
  if(e.target.dataset.act==="del-reward"){
    const id = Number(e.target.dataset.id);
    state.rewards = state.rewards.filter(r=>r.id!==id);
    renderRewards(); saveState(state);
  }
});
$("#redeemBtn").onclick = ()=>{
  const rid = Number($("#rewardSelect").value);
  const r = state.rewards.find(x=>x.id===rid);
  if(!r) return;
  const avail = availablePoints();
  if(avail < r.cost){ alert("积分不足"); return; }
  const limit = Number(state.settings.maxWeeklyRedeem||2);
  if(redeemCountThisWeek() >= limit){ alert("本周兑换次数已达上限"); return; }
  const reserve = $("#reserveDate").value || "";
  state.redeem.push({ts: new Date().toISOString(), weekStart: weekStartStr(), name:r.name, cost:r.cost, reserve});
  if(r.coupon){
    if(!state.coupons[r.name]) state.coupons[r.name] = {count:0, reservations:[]};
    state.coupons[r.name].count += 1;
    if(reserve){ state.coupons[r.name].reservations.push({name:r.name, date:reserve, ts: new Date().toISOString()}); }
    alert(`已兑换时间券：${r.name}（库存 +1）` + (reserve?`，预约日：${reserve}`:""));
  }else{
    alert(`已兑换非券类奖励：${r.name}（请线下执行）`);
  }
  renderRewards(); renderRedeemLog(); renderCoupons(); saveState(state);
};
function renderRedeemLog(){
  const tb = $("#redeemLog tbody"); tb.innerHTML="";
  state.redeem.slice().reverse().forEach(row=>{
    const tr = document.createElement("tr");
    const dt = new Date(row.ts);
    tr.innerHTML = `<td>${dt.toLocaleString()}</td><td>${row.name}</td><td>${row.cost}</td><td>${row.reserve||""}</td>`;
    tb.appendChild(tr);
  });
}

// Coupons
function renderCoupons(){
  ["15 分钟游戏券", "30 分钟游戏券"].forEach(n=>{
    if(!state.coupons[n]) state.coupons[n] = {count:0, reservations:[]};
  });
  const tb = $("#couponTable tbody"); tb.innerHTML="";
  Object.keys(state.coupons).forEach(name=>{
    const tr = document.createElement("tr");
    const count = state.coupons[name].count||0;
    tr.innerHTML = `<td>${name}</td><td>${count}</td>
      <td class="right">
        <button class="btn secondary" data-name="${name}" data-act="add1">+1</button>
        <button class="btn secondary" data-name="${name}" data-act="sub1">-1</button>
      </td>`;
    tb.appendChild(tr);
  });
  const sel = $("#couponSelect"); sel.innerHTML="";
  Object.keys(state.coupons).forEach(name=>{
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = `${name}（库存 ${state.coupons[name].count||0}）`;
    sel.appendChild(opt);
  });
  renderCouponLog();
}
document.getElementById("couponTable").addEventListener("click",(e)=>{
  const act = e.target.dataset.act;
  const name = e.target.dataset.name;
  if(!act || !name) return;
  if(act==="add1"){ state.coupons[name].count = (state.coupons[name].count||0)+1; }
  if(act==="sub1"){ state.coupons[name].count = Math.max(0,(state.coupons[name].count||0)-1); }
  renderCoupons(); saveState(state);
});
document.getElementById("useCouponBtn").onclick = ()=>{
  const name = $("#couponSelect").value;
  const d = $("#couponDate").value || todayStr();
  const limit = Number(state.settings.maxDailyCoupons||1);
  const usedToday = state.couponLogs.filter(x=>x.ts.slice(0,10)===d).length;
  if(usedToday >= limit){ alert("当天使用次数已达上限"); return; }
  if((state.coupons[name]?.count||0) <= 0){ alert("库存不足"); return; }
  state.coupons[name].count -= 1;
  state.couponLogs.push({ts:new Date().toISOString(), name, reserve:d});
  saveState(state);
  renderCoupons(); renderCouponLog();
};
function renderCouponLog(){
  const tb = $("#couponLog tbody"); tb.innerHTML="";
  state.couponLogs.slice().reverse().forEach(row=>{
    const tr = document.createElement("tr");
    const dt = new Date(row.ts);
    tr.innerHTML = `<td>${dt.toLocaleString()}</td><td>${row.name}</td><td>${row.reserve||""}</td>`;
    tb.appendChild(tr);
  });
}

// Report
let chart1=null, chart2=null;
function renderCharts(){
  const labels=[], dataScores=[], taskCounts=[];
  for(let i=5;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-7*i);
    const start = new Date(weekStartStr(d));
    let sum = 0, count=0;
    for(let j=0;j<7;j++){
      const day = new Date(start); day.setDate(start.getDate()+j);
      const kd = day.toISOString().slice(0,10);
      if(state.records[kd]) {
        sum += (state.records[kd].total||0);
        const items = state.records[kd].items || {};
        Object.values(items).forEach(it=>{ if(it.done) count++; });
      }
    }
    labels.push(start.toISOString().slice(0,10));
    dataScores.push(sum);
    taskCounts.push(count);
  }
  const ctx1 = document.getElementById('chartWeeklyScore').getContext('2d');
  const ctx2 = document.getElementById('chartTaskCount').getContext('2d');
  if(chart1) chart1.destroy();
  if(chart2) chart2.destroy();
  chart1 = new Chart(ctx1, { type:'line', data:{ labels, datasets:[{ label:'周总分', data:dataScores }] }, options:{ responsive:true, maintainAspectRatio:false }});
  chart2 = new Chart(ctx2, { type:'bar', data:{ labels, datasets:[{ label:'任务完成次数', data:taskCounts }] }, options:{ responsive:true, maintainAspectRatio:false }});
}

// Settings / I/O
$("#saveSettingsBtn").onclick = ()=>{
  state.settings.maxWeeklyRedeem = Number($("#maxWeeklyRedeem").value||2);
  state.settings.maxDailyPoints = Number($("#maxDailyPoints").value||30);
  state.settings.maxDailyCoupons = Number($("#maxDailyCoupons").value||1);
  state.settings.couponExpireDays = Number($("#couponExpireDays").value||14);
  saveState(state);
  $("#settingsInfo").textContent = "设置已保存"; setTimeout(()=>$("#settingsInfo").textContent="",1500);
  recomputeToday(); renderRewards(); renderCoupons();
};
$("#exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "family_reward_backup_v3.json"; a.click();
  URL.revokeObjectURL(url);
};
$("#importBtn").onclick = ()=>{
  const f = $("#importFile").files[0];
  if(!f){ alert("请选择JSON文件"); return; }
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      state = Object.assign({}, defaultState, obj);
      saveState(state);
      init();
      alert("导入成功");
    }catch(e){ alert("导入失败："+e.message); }
  };
  reader.readAsText(f);
};
$("#resetBtn").onclick = ()=>{
  if(confirm("确定清空所有数据？此操作不可撤销")){ localStorage.removeItem("family_reward_state_pwa_v3"); state = JSON.parse(JSON.stringify(defaultState)); init(); }
};

// Cloud Sync (Supabase)
let sb = null;
const $email = document.getElementById('sb_email');
const $pass = document.getElementById('sb_password');
const $status = document.getElementById('sb_status');
const $url = document.getElementById('sb_url');
const $anon = document.getElementById('sb_anon');
const $family = document.getElementById('family_id');
const $cloudInfo = document.getElementById('cloud_info');
const $auto = document.getElementById('auto_sync');

function initSupabase(){
  const url = localStorage.getItem('sb_url') || $url.value.trim();
  const anon = localStorage.getItem('sb_anon') || $anon.value.trim();
  if(!url || !anon){ return; }
  sb = window.supabase.createClient(url, anon);
  sb.auth.getUser().then(({data})=>{
    if(data && data.user){ $status.textContent = '已登录：' + (data.user.email||''); }
  });
}
document.getElementById('btn_save_cfg').onclick = ()=>{
  localStorage.setItem('sb_url', $url.value.trim());
  localStorage.setItem('sb_anon', $anon.value.trim());
  localStorage.setItem('family_id', $family.value.trim());
  localStorage.setItem('auto_sync', $auto.checked ? '1' : '0');
  alert('配置已保存'); location.reload();
};
document.getElementById('sb_signin').onclick = async ()=>{
  try{
    initSupabase();
    const { data, error } = await sb.auth.signInWithPassword({ email:$email.value.trim(), password:$pass.value });
    if(error) throw error;
    $status.textContent = '已登录：' + (data.user.email||'');
    localStorage.setItem('sb_email', $email.value.trim());
  }catch(e){ alert('登录失败：'+e.message); }
};
document.getElementById('sb_signup').onclick = async ()=>{
  try{
    initSupabase();
    const { data, error } = await sb.auth.signUp({ email:$email.value.trim(), password:$pass.value });
    if(error) throw error;
    $status.textContent = '注册成功，请登录';
  }catch(e){ alert('注册失败：'+e.message); }
};
document.getElementById('sb_signout').onclick = async ()=>{
  if(!sb) initSupabase();
  await sb.auth.signOut();
  $status.textContent = '未登录';
};

async function pullFromCloud(){
  if(!sb) initSupabase();
  const fid = ($family.value.trim() || localStorage.getItem('family_id') || '').trim();
  if(!fid){ alert('请先设置家庭ID'); return; }
  const { data, error } = await sb.from('families_state').select('*').eq('family_id', fid).maybeSingle();
  if(error){ alert('拉取失败：'+error.message); return; }
  if(!data){ $cloudInfo.textContent = '云端：无记录（首次使用，请推送）'; return; }
  const serverUpdated = new Date(data.updated_at).getTime();
  const localMeta = JSON.parse(localStorage.getItem('cloud_meta')||'{}');
  const localUpdated = Number(localMeta.updated_at||0);
  if(serverUpdated <= localUpdated){
    $cloudInfo.textContent = '云端较旧/相同，无需覆盖';
    return;
  }
  state = Object.assign({}, state, data.state_json);
  saveState(state);
  localStorage.setItem('cloud_meta', JSON.stringify({family_id:fid, updated_at:serverUpdated}));
  init();
  $cloudInfo.textContent = '已从云端拉取并覆盖本地（'+ data.updated_at +'）';
}
async function pushToCloud(){
  if(!sb) initSupabase();
  const fid = ($family.value.trim() || localStorage.getItem('family_id') || '').trim();
  if(!fid){ alert('请先设置家庭ID'); return; }
  const payload = { family_id: fid, state_json: state, updated_at: new Date().toISOString() };
  const { data, error } = await sb.from('families_state').upsert(payload).select().maybeSingle();
  if(error){ alert('推送失败：'+error.message); return; }
  const ts = new Date(data.updated_at).getTime();
  localStorage.setItem('cloud_meta', JSON.stringify({family_id:fid, updated_at:ts}));
  $cloudInfo.textContent = '已推送到云端（'+ data.updated_at +'）';
}

document.getElementById('btn_pull').onclick = pullFromCloud;
document.getElementById('btn_push').onclick = pushToCloud;
document.getElementById('btn_backup').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'family_reward_backup_v3.json'; a.click(); URL.revokeObjectURL(url);
};

setInterval(async ()=>{
  if(!$auto.checked) return;
  try{ await pullFromCloud(); await pushToCloud(); }catch(e){}
}, 30000);

// Init UI
function init(){
  renderTabs();
  renderTaskTable();
  renderRewards();
  renderRedeemLog();
  renderCoupons();
  $("#maxWeeklyRedeem").value = state.settings.maxWeeklyRedeem;
  $("#maxDailyPoints").value = state.settings.maxDailyPoints;
  $("#maxDailyCoupons").value = state.settings.maxDailyCoupons;
  $("#couponExpireDays").value = state.settings.couponExpireDays;
  $("#todayDate").textContent = todayStr();
  $url.value = localStorage.getItem('sb_url') || '';
  $anon.value = localStorage.getItem('sb_anon') || '';
  $family.value = localStorage.getItem('family_id') || '';
  $email.value = localStorage.getItem('sb_email') || '';
  $auto.checked = (localStorage.getItem('auto_sync') === '1');
}
init();
</script>
</body>
</html>
