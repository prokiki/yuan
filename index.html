<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111827"/>
<title>家庭激励系统 · PWA v3（云同步）</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f7f7f8; color:#222;}
  header{position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px;}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  .tab{padding:8px 12px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; font-size:14px;}
  .tab.active{background:#111; color:#fff; border-color:#111;}
  main{padding:16px; max-width:1100px; margin:0 auto;}
  section{display:none;}
  section.active{display:block;}
  .card{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .btn{padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#111; color:#fff; cursor:pointer; font-size:14px;}
  .btn.secondary{background:#fff; color:#111;}
  .muted{color:#6b7280; font-size:12px;}
  table{width:100%; border-collapse:collapse; font-size:14px;}
  th,td{border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top;}
</style>
</head>
<body>
<header>
  <div class="update-banner" id="updateBanner" style="display:none;background:#111;color:#fff;padding:8px 12px;text-align:center;">
    发现新版本，<button class="btn" id="refreshBtn" style="padding:4px 8px">点击更新</button>
  </div>
  <h1>家庭激励系统 · PWA v3（云同步）</h1>
  <div class="tabs" id="tabs"></div>
</header>

<main>
  <section id="tab-cloud" class="active">
    <div class="card">
      <h2>登录 / 注册 & 云配置</h2>
      <div class="row">
        <input id="sb_email" placeholder="you@example.com" style="min-width:220px"/>
        <input id="sb_password" type="password" placeholder="至少 6 位" style="min-width:160px"/>
        <button class="btn" id="sb_signin">登录</button>
        <button class="btn secondary" id="sb_signup">注册</button>
        <button class="btn secondary" id="sb_signout">退出登录</button>
        <span class="muted" id="sb_status">未登录</span>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="sb_url" placeholder="https://xxx.supabase.co" style="min-width:280px"/>
        <input id="sb_anon" placeholder="anon key..." style="min-width:280px"/>
        <input id="family_id" placeholder="家庭ID（如 yuan-home）" style="min-width:220px"/>
        <label class="row"><input id="auto_sync" type="checkbox"/> 自动同步（30 秒）</label>
        <button class="btn" id="btn_save_cfg">保存配置</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn_pull">从云端拉取</button>
        <button class="btn" id="btn_push">推送本地到云</button>
        <span class="muted" id="cloud_info">云端：未连接</span>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>操作日志</h3>
        <pre id="logbox" style="white-space:pre-wrap;max-height:200px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px;"></pre>
      </div>
    </div>
  </section>

  <section id="tab-demo">
    <div class="card">
      <h2>北京时间演示（fmtCN）</h2>
      <div class="row"><button class="btn" id="addDemo">添加一条示例记录</button><span class="muted">会以北京时间渲染</span></div>
      <table id="demoTable"><thead><tr><th>时间（北京时间）</th><th>内容</th></tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<script>
// 注册版本化 SW（修改 APP_VERSION 即可强制更新缓存）
const APP_VERSION = 'v3-2025-08-09';
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register(`./sw.js?v=${encodeURIComponent(APP_VERSION)}`).then(reg => {
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            document.getElementById('updateBanner').style.display = 'block';
          }
        });
      });
    });
  });
}
document.getElementById('refreshBtn').onclick = () => {
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({type:'SKIP_WAITING'});
  }
  window.location.reload();
};

// Tabs
const tabs = [{id:"cloud", name:"云同步"}, {id:"demo", name:"北京时间示例"}];
const tabsEl = document.getElementById('tabs');
tabs.forEach((t,i)=>{
  const b = document.createElement('button');
  b.className = 'tab' + (i===0?' active':'');
  b.textContent = t.name;
  b.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('main section').forEach(sec=>sec.classList.remove('active'));
    document.getElementById('tab-'+t.id).classList.add('active');
  };
  tabsEl.appendChild(b);
});

// 统一北京时间格式函数
function fmtCN(ts) {
  if (typeof ts === 'string' && ts.includes('T') && !/[zZ]|[+\-]\d{2}:?\d{2}$/.test(ts)) ts = ts + 'Z';
  const d = ts instanceof Date ? ts : new Date(ts);
  return new Intl.DateTimeFormat('zh-CN', {
    timeZone:'Asia/Shanghai', hour12:false,
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(d);
}

// Demo（fmtCN）
const demo = [];
function renderDemo() {
  const tb = document.querySelector('#demoTable tbody'); tb.innerHTML='';
  demo.slice().reverse().forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtCN(r.ts)}</td><td>${r.text}</td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('addDemo').onclick = ()=>{ demo.push({ts:new Date().toISOString(), text:'完成示例任务'}); renderDemo(); };

// 云同步（简化）
let sb = null;
const $email = document.getElementById('sb_email');
const $pass = document.getElementById('sb_password');
const $status = document.getElementById('sb_status');
const $url = document.getElementById('sb_url');
const $anon = document.getElementById('sb_anon');
const $family = document.getElementById('family_id');
const $cloudInfo = document.getElementById('cloud_info');
const $auto = document.getElementById('auto_sync');
const $log = document.getElementById('logbox');
function logx(tag, obj){ const t=new Date().toISOString(); $log.textContent += `[${t}] ${tag}\n` + (obj? (typeof obj==='string'?obj:JSON.stringify(obj,null,2)):'') + "\n\n"; $log.scrollTop=$log.scrollHeight; }

function initSupabase(){
  const url = localStorage.getItem('sb_url') || $url.value.trim();
  const anon = localStorage.getItem('sb_anon') || $anon.value.trim();
  if(!url || !anon) return;
  sb = window.supabase.createClient(url, anon);
  sb.auth.getUser().then(({data})=>{ if(data && data.user) $status.textContent = '已登录：' + (data.user.email||''); });
}
document.getElementById('btn_save_cfg').onclick = ()=>{
  localStorage.setItem('sb_url', $url.value.trim());
  localStorage.setItem('sb_anon', $anon.value.trim());
  localStorage.setItem('family_id', $family.value.trim());
  localStorage.setItem('auto_sync', $auto.checked ? '1' : '0');
  alert('配置已保存'); location.reload();
};
document.getElementById('sb_signin').onclick = async ()=>{ try{ initSupabase(); const {data,error}=await sb.auth.signInWithPassword({email:$email.value.trim(),password:$pass.value}); if(error) throw error; $status.textContent='已登录：'+(data.user.email||''); logx('signin ok', data); }catch(e){ alert('登录失败：'+e.message); logx('signin fail', e); } };
document.getElementById('sb_signup').onclick = async ()=>{ try{ initSupabase(); const {data,error}=await sb.auth.signUp({email:$email.value.trim(),password:$pass.value}); if(error) throw error; $status.textContent='注册成功，请登录'; logx('signup ok', data); }catch(e){ alert('注册失败：'+e.message); logx('signup fail', e); } };
document.getElementById('sb_signout').onclick = async ()=>{ if(!sb) initSupabase(); await sb.auth.signOut(); $status.textContent='未登录'; logx('signout', 'done'); };

async function pullFromCloud(){
  try{
    if(!sb) initSupabase();
    const fid = ($family.value.trim() || localStorage.getItem('family_id') || '').trim();
    if(!fid) return alert('请先设置家庭ID');
    const { data, error } = await sb.from('families_state').select('*').eq('family_id', fid).maybeSingle();
    if(error) throw error;
    if(!data) { $cloudInfo.textContent = '云端：无记录（首次推送）'; logx('pull empty',''); return; }
    localStorage.setItem('family_reward_state_pwa_v3', JSON.stringify(data.state_json));
    localStorage.setItem('cloud_meta', JSON.stringify({family_id:fid, updated_at: new Date(data.updated_at).getTime()}));
    $cloudInfo.textContent = '已拉取：' + fmtCN(data.updated_at);
    logx('pull ok', data);
  }catch(e){ alert('拉取失败：'+e.message); logx('pull fail', e); }
}
async function pushToCloud(){
  try{
    if(!sb) initSupabase();
    const fid = ($family.value.trim() || localStorage.getItem('family_id') || '').trim();
    if(!fid) return alert('请先设置家庭ID');
    const state = JSON.parse(localStorage.getItem('family_reward_state_pwa_v3') || '{}');
    const payload = { family_id:fid, state_json: state, updated_at: new Date().toISOString() };
    const { data, error } = await sb.from('families_state').upsert(payload).select().maybeSingle();
    if(error) throw error;
    $cloudInfo.textContent = '已推送：' + fmtCN(data.updated_at);
    logx('push ok', data);
  }catch(e){ alert('推送失败：'+(e.message||e)); logx('push fail', e); }
}
document.getElementById('btn_pull').onclick = pullFromCloud;
document.getElementById('btn_push').onclick = pushToCloud;
setInterval(async ()=>{ if($auto.checked){ try{ await pullFromCloud(); await pushToCloud(); }catch(_e){} } }, 30000);

// Prefill & init
(function(){
  $url.value = localStorage.getItem('sb_url') || '';
  $anon.value = localStorage.getItem('sb_anon') || '';
  $family.value = localStorage.getItem('family_id') || '';
  $email.value = localStorage.getItem('sb_email') || '';
  $auto.checked = (localStorage.getItem('auto_sync') === '1');
  renderDemo();
})();
</script>
</body>
</html>
